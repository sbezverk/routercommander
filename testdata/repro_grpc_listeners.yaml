#
# In collect mode, routercommander collects the output of commands defined under main_command_group tag
# if commands do not have patterns to look for a specific text in the output or matching against patterns
# is not required, health_check should be set to false.
collect:
  health_check: false
#
# In repro mode, the commands defined under the main_command_group tag are  used to trigger and detect
# a specific issue. In most common case, after the issue is triggered, commands defined by
# postmortem_command_group is collected.
# command_processing_rules is optional and considered an advanced feature which allow further
# customization of the commands to execute as a part of the postmortem.
repro:
  #
  # times defines a number of iterations main_command_group is executed.
  times: 100
  #
  # interval defines an interval between iterations.
  interval: 10
  #
  # command_processing_rules optional and advanced feature,
  # defines special processing rules for a command which triggered the match.
  # Optional if no special processing is needed.
  command_processing_rules:
    #
    # command tag must match to one of the command tag from the main_command_group, under
    # this tag the special instructions for its processing are listed.
    - command: "commit"
      tests:
        - id: 1
          pattern:
            pattern_string: 'Failed to commit'
    - command: "bash netstat -tunlp"
      tests:
        - id: 1
          pattern:
            pattern_string: ':9339'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "0.0.0.0:9339"
          check_all_results: true
        - id: 2
          pattern:
            pattern_string: ':57401'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "0.0.0.0:57401"
        - id: 3
          pattern:
            pattern_string: ':9339'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "1.1.1.1:9339"
          # Command to execute if condition is met
          if_triggered_commands:
            - command: "bash netstat -tunlp"
        - id: 4
          pattern:
            pattern_string: ':57401'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "1.1.1.1:57401"
        - id: 5
          pattern:
            pattern_string: ':9339'
          number_of_occurrences: 4
        - id: 6
          pattern:
            pattern_string: ':9339'
          number_of_occurrences: 3
        - id: 7
          pattern:
            pattern_string: ':9339'
          field_separator: " "
          check_all_results: true
          occurrence: 3
          fields:
            - field_number: 4
              operation: "contain_substring"
              value: ":9339"
        - id: 8
          pattern:
            pattern_string: ':9339'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "not_contain_substring"
              value: "3.3.3.3"
        - id: 11
          pattern:
            pattern_string: ':9340'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "0.0.0.0:9340"
        - id: 12
          pattern:
            pattern_string: ':57401'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "0.0.0.0:57401"
        - id: 13
          pattern:
            pattern_string: ':9340'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "1.1.1.1:9340"
                    # Command to execute if condition is met
          if_triggered_commands:
            - command: "bash netstat -tunlp"
        - id: 14
          pattern:
            pattern_string: ':57401'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "compare_with_value_neq"
              value: "1.1.1.1:57401"
        - id: 15
          pattern:
            pattern_string: ':9340'
          number_of_occurrences: 4
        - id: 16
          pattern:
            pattern_string: ':9340'
          number_of_occurrences: 3
        - id: 17
          pattern:
            pattern_string: ':9340'
          field_separator: " "
          check_all_results: true
          occurrence: 3
          fields:
            - field_number: 4
              operation: "contain_substring"
              value: ":9340"
        - id: 18
          pattern:
            pattern_string: ':9340'
          field_separator: " "
          check_all_results: true
          fields:
            - field_number: 4
              operation: "not_contain_substring"
              value: "3.3.3.3"
    - command: 'bash gnmi_client_linux --grpc="127.0.0.1:9339"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
        - id: 2
          pattern:
            pattern_string: 'Result: Success'
    - command: 'bash gnmi_client_linux --grpc="127.0.0.1:57401"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
        - id: 2
          pattern:
            pattern_string: 'Result: Success'
    - command: 'bash gnmi_client_linux --grpc="1.1.1.1:9339"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
    - command: 'bash gnmi_client_linux --grpc="2.2.2.2:9339"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
    - command: 'bash gnmi_client_linux --grpc="3.3.3.3:9339"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
        - id: 2
          pattern:
            pattern_string: 'Result: Success'
    - command: 'bash gnmi_client_linux --grpc="4.4.4.4:9339"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
    - command: 'bash gribi_client_linux --grpc="127.0.0.1:9340"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
        - id: 2
          pattern:
            pattern_string: 'Result: Success'
    - command: 'bash gribi_client_linux --grpc="127.0.0.1:57401"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
        - id: 2
          pattern:
            pattern_string: 'Result: Success'
    - command: 'bash gribi_client_linux --grpc="1.1.1.1:9340"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
    - command: 'bash gribi_client_linux --grpc="2.2.2.2:9340"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
    - command: 'bash gribi_client_linux --grpc="3.3.3.3:9340"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
        - id: 2
          pattern:
            pattern_string: 'Result: Success'
    - command: 'bash gribi_client_linux --grpc="4.4.4.4:9340"'
      tests:
        - id: 1
          pattern:
            pattern_string: 'Result: Failure'
  #
  # Defines a list of global post mortem commands which will be executed
  # regardless which command and pattern triggered the match.
  postmortem_command_group:
    - command: 'bash netstat -tunlp'
#
# Defines a command group used  to either collect information as in case of collect mode,
# or to reproduce an issue as in case of repro mode.
main_command_group:
  # Clean up before running tests
  - command: "configure term"
  - command: "grpc"
  - command: "no listen-addresses"
  - command: "no gribi"
  - command: "no gnmi"
  - command: "commit"
    process_results: true
    command_test_id: 1
  # Condigure gnmi with default config
  - command: "gnmi"
  - command: "gribi"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 0.0.0.0:9339 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 1
  # Checking for connectivity by using a gnmi client to default port 9339
  - command: 'bash gnmi_client_linux --grpc="127.0.0.1:9339"'
    process_result: true
    command_test_id: 1

  # Check if there is 0.0.0.0:9340 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 11
  # Checking for connectivity by using a gnmi client to default port 9339
  - command: 'bash gribi_client_linux --grpc="127.0.0.1:9340"'
    process_result: true
    command_test_id: 1

  # Test 2 simple gNMI service configuration with default port 57401
  - command: "configure term"
  - command: "grpc"
  - command: "gnmi"
  - command: "port 57401"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 0.0.0.0:57401 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 2
    patterns:
      - pattern_string: ":57401"
  # Checking for connectivity by using a gnmi client to default port 9339, it should fail
  - command: 'bash gnmi_client_linux --grpc="127.0.0.1:9339"'
    process_result: true
    command_test_id: 2
  # Checking for connectivity by using a gnmi client to non default port 57401, it should succeed
  - command: 'bash gnmi_client_linux --grpc="127.0.0.1:57401"'
    process_result: true
    command_test_id: 1

  # Test 2 simple gNMI service configuration with default port 57401
  - command: "configure term"
  - command: "grpc"
  - command: "gribi"
  - command: "port 57401"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 0.0.0.0:57401 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 12
    patterns:
      - pattern_string: ":57401"
  # Checking for connectivity by using a gribi client to default port 9340, it should fail
  - command: 'bash gribi_client_linux --grpc="127.0.0.1:9340"'
    process_result: true
    command_test_id: 2
  # Checking for connectivity by using a gribi client to non default port 57401, it should succeed
  - command: 'bash gribi_client_linux --grpc="127.0.0.1:57401"'
    process_result: true
    command_test_id: 1
  - command: "configure term"
  - command: "grpc"
  - command: "gnmi"
  - command: "no port"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 0.0.0.0:9339 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 1
  - command: "configure term"
  - command: "grpc"
  - command: "gribi"
  - command: "no port"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 0.0.0.0:9340 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 11
  - command: "configure term"
  - command: "grpc"
  - command: "no gnmi"
  - command: "no gribi"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Apply listen-address command and repeat tests
  - command: "configure term"
  - command: "grpc"
  - command: "listen-addresses 1.1.1.1"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Test 21 simple gNMI service configuration with default port 9339
  - command: "configure term"
  - command: "grpc"
  - command: "gnmi"
  - command: "gribi"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 1.1.1.1:9339 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 3
  # Check if there is 1.1.1.1:9340 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 13
  # Test 22 simple gNMI service configuration with custom port 57401
  - command: "configure term"
  - command: "grpc"
  - command: "gnmi"
  - command: "port 57401"
  - command: "gribi"
  - command: "port 57401"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 1.1.1.1:57401 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 4
    # Check if there is 1.1.1.1:57401 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 14
  # Test 23 simple gNMI service confiugration with default port 9339
  - command: "configure term"
  - command: "grpc"
  - command: "gnmi"
  - command: "no port"
  - command: "gribi"
  - command: "no port"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Check if there is 1.1.1.1:9339 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 3
    # Check if there is 1.1.1.1:9340 entry
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 13

  # Test with multiple listenets
  - command: "configure term"
  - command: "grpc"
  - command: "listen-addresses 1.1.1.1 2.2.2.2 3.3.3.3 4.4.4.4"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 5
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 15
  # Checking for connectivity by using a gnmi client to all configured
  # listen addresses on default port 9339
  - command: 'bash gnmi_client_linux --grpc="1.1.1.1:9339"'
    process_result: true
    command_test_id: 1
  - command: 'bash gnmi_client_linux --grpc="2.2.2.2:9339"'
    process_result: true
    command_test_id: 1
  - command: 'bash gnmi_client_linux --grpc="3.3.3.3:9339"'
    process_result: true
    command_test_id: 1
  - command: 'bash gnmi_client_linux --grpc="4.4.4.4:9339"'
    process_result: true
    command_test_id: 1
  - command: 'bash gribi_client_linux --grpc="1.1.1.1:9340"'
    process_result: true
    command_test_id: 1
  - command: 'bash gribi_client_linux --grpc="2.2.2.2:9340"'
    process_result: true
    command_test_id: 1
  - command: 'bash gribi_client_linux --grpc="3.3.3.3:9340"'
    process_result: true
    command_test_id: 1
  - command: 'bash gribi_client_linux --grpc="4.4.4.4:9340"'
    process_result: true
    command_test_id: 1
  - command: "configure term"
  - command: "grpc"
  - command: "listen-addresses 1.1.1.1 2.2.2.2 4.4.4.4"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
# Test if number of listening address is 3
#gNMI
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 6
#gRIBI
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 16
# Test if 3.3.3.3 is not seen in the output
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 8
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 18
# Test if now there are only 3 listening address for port 9339
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 7
  - command: "bash netstat -tunlp"
    process_result: true
    command_test_id: 17
# Test connectivity again, connection to 3.3.3.3 should fail, but
# the rest listeners should be ok
  - command: 'bash gnmi_client_linux --grpc="1.1.1.1:9339"'
    process_result: true
    command_test_id: 1
  - command: 'bash gnmi_client_linux --grpc="2.2.2.2:9339"'
    process_result: true
    command_test_id: 1
    # This test should fail as listener 3.3.3.3 has been removed
  - command: 'bash gnmi_client_linux --grpc="3.3.3.3:9339"'
    process_result: true
    command_test_id: 2
  - command: 'bash gnmi_client_linux --grpc="4.4.4.4:9339"'
    process_result: true
    command_test_id: 1

  - command: 'bash gribi_client_linux --grpc="1.1.1.1:9340"'
    process_result: true
    command_test_id: 1
  - command: 'bash gribi_client_linux --grpc="2.2.2.2:9340"'
    process_result: true
    command_test_id: 1
    # This test should fail as listener 3.3.3.3 has been removed
  - command: 'bash gribi_client_linux --grpc="3.3.3.3:9340"'
    process_result: true
    command_test_id: 2
  - command: 'bash gribi_client_linux --grpc="4.4.4.4:9340"'
    process_result: true
    command_test_id: 1

  # Restoring default configuration
  - command: "configure term"
  - command: "grpc"
  - command: "no gnmi"
  - command: "no gribi"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
  # Remove listen-address command and repeat tests
  - command: "configure term"
  - command: "grpc"
  - command: "no listen-address 1.1.1.1"
  - command: "commit"
    process_results: true
    command_test_id: 1
  - command: "end"
